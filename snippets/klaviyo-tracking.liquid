{% comment %}
  Klaviyo Onsite Event Tracking
  Fires Viewed Product, trackViewedItem, and Added to Cart events
  explicitly so Klaviyo abandonment flows trigger reliably.

  Also handles cart recovery from Klaviyo abandon cart emails:
  landing the customer on the site with their cart rebuilt
  and the cart drawer open.
{% endcomment %}

{%- if template.name == 'product' -%}
  <script>
    var _learnq = window._learnq || [];

    _learnq.push(['track', 'Viewed Product', {
      ProductName: {{ product.title | json }},
      ProductID: {{ product.id }},
      SKU: {{ product.selected_or_first_available_variant.sku | json }},
      Categories: {{ product.collections | map: 'title' | json }},
      ImageURL: {{ product.featured_image | image_url: width: 1024 | json }},
      URL: {{ product.url | prepend: shop.url | json }},
      Brand: {{ product.vendor | json }},
      Price: {{ product.selected_or_first_available_variant.price | divided_by: 100.0 }},
      CompareAtPrice: {{ product.selected_or_first_available_variant.compare_at_price | default: product.selected_or_first_available_variant.price | divided_by: 100.0 }}
    }]);

    _learnq.push(['trackViewedItem', {
      Title: {{ product.title | json }},
      ItemId: {{ product.id }},
      Categories: {{ product.collections | map: 'title' | json }},
      ImageUrl: {{ product.featured_image | image_url: width: 1024 | json }},
      Url: {{ product.url | prepend: shop.url | json }},
      Metadata: {
        Brand: {{ product.vendor | json }},
        Price: {{ product.selected_or_first_available_variant.price | divided_by: 100.0 }},
        CompareAtPrice: {{ product.selected_or_first_available_variant.compare_at_price | default: product.selected_or_first_available_variant.price | divided_by: 100.0 }}
      }
    }]);
  </script>
{%- endif -%}

<script>
  (function () {
    var _learnq = window._learnq || [];

    /* =========================================
       Track: Added to Cart
       ========================================= */
    document.addEventListener('cart:update', function (e) {
      if (!e.detail || !e.detail.data) return;
      if (!e.detail.data.itemCount || e.detail.data.didError) return;
      if (e.detail.data.source === 'klaviyo-recovery') return;

      var addedProductId = e.detail.data.productId;
      var addedQuantity = e.detail.data.itemCount || 1;

      fetch('/cart.js', { credentials: 'same-origin' })
        .then(function (r) { return r.json(); })
        .then(function (cart) {
          if (!cart || !cart.items || cart.items.length === 0) return;

          var items = [];
          var itemNames = [];
          var totalValue = 0;
          var addedItem = null;

          for (var i = 0; i < cart.items.length; i++) {
            var item = cart.items[i];
            itemNames.push(item.product_title);
            totalValue += item.final_line_price;
            items.push({
              ProductID: item.product_id,
              SKU: item.sku || '',
              ProductName: item.product_title,
              Quantity: item.quantity,
              ItemPrice: (item.final_price / 100).toFixed(2),
              RowTotal: (item.final_line_price / 100).toFixed(2),
              ProductURL: window.location.origin + item.url,
              ImageURL: item.featured_image ? item.featured_image.url : '',
              ProductCategories: []
            });

            if (addedProductId && String(item.product_id) === String(addedProductId)) {
              addedItem = item;
            }
          }

          if (!addedItem) addedItem = cart.items[cart.items.length - 1];

          var cartParam = cart.items.map(function (item) {
            return item.variant_id + ':' + item.quantity;
          }).join(',');
          var checkoutURL = window.location.origin + '/?recover_cart=' + cartParam;

          _learnq.push(['track', 'Added to Cart', {
            $value: (totalValue / 100).toFixed(2),
            AddedItemProductName: addedItem.product_title,
            AddedItemProductID: addedItem.product_id,
            AddedItemSKU: addedItem.sku || '',
            AddedItemCategories: [],
            AddedItemImageURL: addedItem.featured_image ? addedItem.featured_image.url : '',
            AddedItemURL: window.location.origin + addedItem.url,
            AddedItemPrice: (addedItem.final_price / 100).toFixed(2),
            AddedItemQuantity: addedQuantity,
            ItemNames: itemNames,
            CheckoutURL: checkoutURL,
            Items: items
          }]);
        })
        .catch(function () {});
    });

    /* =========================================
       Cart Recovery from Klaviyo Emails
       Reads ?recover_cart=variantId:qty,variantId:qty
       Rebuilds the cart via AJAX, then opens the
       cart drawer so the customer lands on the site
       with their items visible and ready to check out.
       ========================================= */
    var params = new URLSearchParams(window.location.search);
    var recoverParam = params.get('recover_cart');

    if (recoverParam) {
      var recoverItems = [];
      recoverParam.split(',').forEach(function (pair) {
        var parts = pair.split(':');
        if (parts.length === 2) {
          recoverItems.push({ id: parseInt(parts[0], 10), quantity: parseInt(parts[1], 10) });
        }
      });

      if (recoverItems.length > 0) {
        var cleanUrl = new URL(window.location.href);
        cleanUrl.searchParams.delete('recover_cart');
        history.replaceState({}, '', cleanUrl.toString());

        function doRecover() {
          fetch('/cart/clear.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(function () {
            return fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ items: recoverItems })
            });
          })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            document.dispatchEvent(new CustomEvent('cart:update', {
              bubbles: true,
              detail: {
                resource: data,
                sourceId: 'klaviyo-recovery',
                data: { source: 'klaviyo-recovery' }
              }
            }));

            var cartDrawer = document.querySelector('cart-drawer-component');
            if (cartDrawer && typeof cartDrawer.open === 'function') {
              cartDrawer.open();
            }
          })
          .catch(function () {
            window.location.href = '/cart';
          });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', doRecover);
        } else {
          doRecover();
        }
      }
    }
  })();
</script>
