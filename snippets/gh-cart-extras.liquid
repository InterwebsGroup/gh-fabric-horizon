{% comment %}
  Giant Hoodies Cart Extras
  Renders upsell messaging and shipping progress bar.
  Usage:
    {% render 'gh-cart-extras', part: 'top' %}  — upsell banner + shipping bar
{% endcomment %}

{% case part %}
{% when 'top' %}

  {%- comment -%} ——— Hoodie Count ——— {%- endcomment -%}
  {%- liquid
    assign tier_handles = settings.tier_collection_handles | split: ','
    assign hoodie_count = 0

    for item in cart.items
      assign is_excluded = false
      for tag in item.product.tags
        assign tag_strip = tag | strip
        if tag_strip == settings.tier_exclude_tag
          assign is_excluded = true
          break
        endif
      endfor

      unless is_excluded
        assign matched_tier = false
        for collection in item.product.collections
          for handle in tier_handles
            assign handle_trimmed = handle | strip
            if collection.handle == handle_trimmed
              assign matched_tier = true
              break
            endif
          endfor
          if matched_tier
            break
          endif
        endfor

        if matched_tier
          assign hoodie_count = hoodie_count | plus: item.quantity
        endif
      endunless
    endfor
  -%}

  {%- comment -%} ——— Upsell Banner ——— {%- endcomment -%}
  {%- if settings.cart_upsell_enabled -%}
    {%- liquid
      if settings.pricing_mode == 'flat'
        assign upsell_msg = settings.upsell_flat_mode
        assign show_cta = false
      else
        assign show_cta = true
        case hoodie_count
          when 0
            assign upsell_msg = settings.upsell_0_hoodies
          when 1
            assign upsell_msg = settings.upsell_1_hoodie
          when 2
            assign upsell_msg = settings.upsell_2_hoodies
          else
            assign upsell_msg = settings.upsell_3_plus
            assign show_cta = false
        endcase
      endif
    -%}

    <div class="gh-cart-upsell">
      <p class="gh-cart-upsell__msg">
        {{- upsell_msg -}}
        {%- if show_cta -%}
          <a href="/collections/hoodies" class="gh-cart-upsell__cta">Browse Hoodies &rarr;</a>
        {%- endif -%}
      </p>
    </div>
  {%- endif -%}

  {%- comment -%} ——— Shipping Progress Bar ——— {%- endcomment -%}
  {%- if settings.show_shipping_progress_bar -%}
    {%- liquid
      assign threshold_cents = settings.free_shipping_threshold | times: 100
      assign remaining_cents = threshold_cents | minus: cart.total_price
      assign progress = cart.total_price | times: 100 | divided_by: threshold_cents
      if progress > 100
        assign progress = 100
      endif

      assign is_free = false
      if remaining_cents <= 0
        assign is_free = true
      endif
    -%}

    <div class="gh-shipping-progress{% if is_free %} gh-shipping-progress--complete{% endif %}">
      <div class="gh-shipping-progress__header">
        {%- if is_free -%}
          <p class="gh-shipping-progress__msg">{{ settings.shipping_free_msg }}</p>
        {%- else -%}
          {%- assign remaining_formatted = remaining_cents | money -%}
          {%- assign shipping_msg = settings.shipping_progress_msg | replace: '[amount]', remaining_formatted -%}
          <p class="gh-shipping-progress__msg">{{ shipping_msg }}</p>
        {%- endif -%}
        <span class="gh-shipping-progress__icon" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
        </span>
      </div>
      <div class="gh-shipping-progress__bar">
        <div class="gh-shipping-progress__fill" style="width: {{ progress }}%;"></div>
      </div>
    </div>
  {%- endif -%}

{% endcase %}
