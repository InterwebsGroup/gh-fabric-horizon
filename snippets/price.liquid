{%- doc -%}
  This snippet is used to render a product card.
  It is used in the product block,featured product block, and the product card block.

  @param {product} product_resource - The product to render
  @param {boolean} [show_unit_price] - Whether to show the unit price
  @param {boolean} [show_sale_price_first] - Whether to show the sale price first
{%- enddoc -%}

{%- liquid
  assign show_unit_price = show_unit_price | default: false
  assign show_sale_price_first = show_sale_price_first | default: false
  assign selected_variant = product_resource.selected_or_first_available_variant
  assign price = selected_variant.price
  assign compare_at_price = selected_variant.compare_at_price

  assign show_compare_price = false
  if compare_at_price > price
    assign show_compare_price = true
  endif

  # Calculate savings amount
  assign savings_amount = 0
  if show_compare_price
    assign savings_amount = compare_at_price | minus: price
  endif

  if product_resource == blank
    assign price = 1999
  endif

  # Check if variant has volume pricing
  assign has_volume_pricing = null
  assign price_min = null
  assign price_max = null

  # For product cards (collection/search pages), calculate min/max across all variants
  # For product pages, only use the selected variant's pricing
  assign is_product_card = false
  if template.name != 'product'
    assign is_product_card = true
  endif

  if is_product_card
    assign price_min = product_resource.price_min
    assign price_max = product_resource.price_max
    assign has_volume_pricing = product_resource.quantity_price_breaks_configured? | default: false
  else
    # Product page: only use selected variant's pricing
    if selected_variant.quantity_price_breaks.size > 0
      assign has_volume_pricing = true
      assign price_min = selected_variant.quantity_price_breaks.last.price
      assign price_max = selected_variant.price
    endif
  endif

  # Format all prices (no currency code - site is USD only)
  assign price = price | money
  assign compare_at_price = compare_at_price | money
  assign price_min = price_min | money
  assign price_max = price_max | money
  assign savings_formatted = savings_amount | money
-%}

<div ref="priceContainer">
  {% if has_volume_pricing %}
    {% comment %} Volume pricing display {% endcomment %}
    {% if show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
        <span class="compare-at-price">{{- compare_at_price -}}</span>
      </span>
    {% endif %}
    <span role="group">
      <span class="visually-hidden">{{ 'content.price_range' | t }}&nbsp;</span>
      <span class="price price-range price--large">{{ price_min }} - {{ price_max }}</span>
    </span>
  {% else %}
    {% comment %} Standard pricing display {% endcomment %}
    {% if show_sale_price_first == false and show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
        <span class="compare-at-price">{{- compare_at_price -}}</span>
      </span>
    {% endif %}

    {% if show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_sale' | t }}&nbsp;</span>
        <span class="price">{{ price | default: '&nbsp;' }}</span>
      </span>
    {% else %}
      <span class="price">{{ price | default: '&nbsp;' }}</span>
    {% endif %}

    {% if show_sale_price_first == true and show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
        <span class="compare-at-price">{{- compare_at_price -}}</span>
      </span>
    {% endif %}

    {% comment %} Display savings amount {% endcomment %}
    {% if show_compare_price and savings_amount > 0 %}
      <span class="price-savings">Save {{ savings_formatted }}+</span>
    {% endif %}
  {% endif %}
  {%- if selected_variant.unit_price and show_unit_price %}
    {%- assign unit_price = selected_variant.unit_price | money -%}
    {% render 'unit-price', price: unit_price, measurement: selected_variant.unit_price_measurement %}
  {%- endif -%}
</div>
{%- if has_volume_pricing -%}
  <small class="volume-pricing-note">{{ 'content.volume_pricing_available' | t }}</small>
{%- endif -%}

{%- comment -%} Giant Hoodies tiered pricing message for product cards {%- endcomment -%}
{%- if is_product_card and settings.pricing_mode == 'tiered' -%}
  {%- assign is_tier_eligible = false -%}
  {%- assign tier_handles = settings.tier_collection_handles | split: ',' -%}
  {%- for handle in tier_handles -%}
    {%- assign handle_stripped = handle | strip -%}
    {%- for collection in product_resource.collections -%}
      {%- if collection.handle == handle_stripped -%}
        {%- unless product_resource.tags contains settings.tier_exclude_tag -%}
          {%- assign is_tier_eligible = true -%}
        {%- endunless -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endfor -%}
  {%- if is_tier_eligible -%}
    {%- assign tier_max_discount = settings.tier_retail_price | minus: settings.tier_3_price | times: 100 | divided_by: settings.tier_retail_price -%}
    <small class="gh-tiered-pricing-note">Buy 2+, save up to {{ tier_max_discount }}%</small>
  {%- endif -%}
{%- endif -%}
